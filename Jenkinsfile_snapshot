pipeline {
    agent any

    stages {
        stage('1. Checkout Code') {
            steps { checkout scm }
        }

        stage('2. Instalar Dependencias AWS') {
             steps {
                 sh 'pip3 install boto3 botocore --user'
             }
        }

        stage('3. Snapshot Forense SERVER0') {
            steps {
                echo 'Iniciando snapshot para EC2 Server 0...'
                
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'aws-ec2-key-leomed', keyFileVariable: 'KEY_AWS_LEOMED'),
                    usernamePassword(credentialsId: 'aws-api-credentials-ec0', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh """
                        export PYTHONPATH=/var/lib/jenkins/.local/lib/python3.10/site-packages
                        
                        eval \$(ssh-agent -s)
                        ssh-add ${env.KEY_AWS_LEOMED}
                        
                        ansible-playbook -i hosts.ini playbook_snapshot.yml -l ec2_server0
                        
                        ssh-agent -k
                    """
                }
            }
        }

        stage('4. Snapshot Forense SERVER1') {
            steps {
                echo 'Iniciando snapshot para EC2 Server 1...'
                
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'aws-ec2-key-fernando', keyFileVariable: 'KEY_AWS_FERNANDO'),
                    usernamePassword(credentialsId: 'aws-api-credentials-ec1', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh """
                        export PYTHONPATH=/var/lib/jenkins/.local/lib/python3.10/site-packages
                        
                        eval \$(ssh-agent -s)
                        ssh-add ${env.KEY_AWS_FERNANDO}
                        
                        ansible-playbook -i hosts.ini playbook_snapshot.yml -l ec2_server1
                        
                        ssh-agent -k
                    """
                }
            }
        }
    }
    
    post {
        success { echo '¡Snapshots Forenses completados!' }
        failure { echo '¡Error al tomar Snapshots!' }
    }
}